# LEFTHOOK CONFIGURATION
# Refer to https://github.com/evilmartians/lefthook for docs

commit-msg:
  commands:
    # 1. Enforce Commit Message Format (Conventional Commits)
    # Example: feat(auth): add login button
    lint-commit-msg:
      run: |
        if ! head -n1 {1} | grep -Eq "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,72}$"; then
          echo "❌ Invalid commit message format."
          echo "Expected: type(scope): subject"
          echo "Example: feat(auth): add login button"
          echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
          exit 1
        fi

pre-commit:
  parallel: true
  commands:
    # 2. Enforce Branch Naming
    # Example: feat/new-login-flow
    lint-branch-name:
      run: |
        BRANCH_NAME=$(git symbolic-ref --short HEAD)
        # Skip if detached HEAD or no branch
        if [ -z "$BRANCH_NAME" ]; then exit 0; fi
        
        if ! echo "$BRANCH_NAME" | grep -Eq "^(feat|bug|fix|refactor|docs|style|test|chore|ci)\/[a-z0-9_\-]+$"; then
          echo "⚠️  Action Required: Invalid branch name '$BRANCH_NAME'"
          echo "Expected format: type/description"
          echo "Example: feat/new-login-flow"
          echo "Allowed types: feat, bug, fix, refactor, docs, style, test, chore, ci"
          # Exiting with 1 would block the commit. 
          # Uncomment the next line to strictly enforce it:
          # exit 1 
        fi

    # 3. Check Formatting (Flutter/Dart)
    format-check-dart:
      glob: "*.dart"
      run: dart format --set-exit-if-changed {staged_files}
    
    # 4. Check Formatting (Rust)
    format-check-rust:
      glob: "*.rs"
      run: cargo fmt -- --check

pre-push:
  commands:
    # 5. Run Full CI Checks before pushing
    check-all:
      run: make check
