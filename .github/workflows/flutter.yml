name: Flutter CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apps/**'
      - 'packages/**'
      - '.github/workflows/flutter.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'apps/**'
      - 'packages/**'
      - '.github/workflows/flutter.yml'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
      
      - name: Get dependencies (nomade_ui)
        working-directory: ./packages/nomade_ui
        run: flutter pub get
      
      - name: Get dependencies (nomade_domain)
        working-directory: ./packages/nomade_domain
        run: flutter pub get
      
      - name: Get dependencies (nomade_protocol)
        working-directory: ./packages/nomade_protocol
        run: flutter pub get
      
      - name: Get dependencies (nomade_app)
        working-directory: ./apps/nomade_app
        run: flutter pub get
      
      - name: Run dart analyze
        working-directory: ./apps/nomade_app
        run: dart analyze

  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
      
      - name: Check format (packages)
        run: dart format --set-exit-if-changed packages/
      
      - name: Check format (apps)
        run: dart format --set-exit-if-changed apps/

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
      
      - name: Get dependencies (nomade_ui)
        working-directory: ./packages/nomade_ui
        run: flutter pub get
      
      - name: Get dependencies (nomade_domain)
        working-directory: ./packages/nomade_domain
        run: flutter pub get
      
      - name: Get dependencies (nomade_protocol)
        working-directory: ./packages/nomade_protocol
        run: flutter pub get
      
      - name: Get dependencies (nomade_app)
        working-directory: ./apps/nomade_app
        run: flutter pub get
      
      - name: Run tests (nomade_ui)
        working-directory: ./packages/nomade_ui
        run: flutter test
      
      # Note: nomade_domain uses 'dart test' not 'flutter test'
      - name: Run tests (nomade_domain)
        working-directory: ./packages/nomade_domain
        run: dart test || echo "No tests yet"
      
      # Note: nomade_protocol uses 'dart test' not 'flutter test'
      - name: Run tests (nomade_protocol)
        working-directory: ./packages/nomade_protocol
        run: dart test || echo "No tests yet"
      
      - name: Run tests (nomade_app)
        working-directory: ./apps/nomade_app
        run: flutter test || echo "No tests yet"
